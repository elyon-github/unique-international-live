<?xml version="1.0" encoding='utf-8'?>
<odoo>
	<record id="so_accomplishment_report_bind" model="ir.actions.report">
		<field name="name">Project Accomplishment Report</field>
		<field name="model">sale.order</field>
		<field name="report_type">qweb-pdf</field>
		<field name="report_name">unique_ar.so_accomplishment_report_layout</field>
		<field name="report_file">unique_ar.so_accomplishment_report_layout</field>
		<field name="binding_model_id" ref="sale.model_sale_order"/>
		<field name="binding_type">report</field>
	</record>

	<template id="so_accomplishment_report_layout">
		<t t-call='web.basic_layout'>
			<t t-foreach="docs" t-as="doc">
				<!-- <t t-call='web.internal_layout'> -->
					<div class="container">
						<t t-set='cust' t-value="request.env['res.partner'].search([('id', '=', doc.partner_id.id)])"/>
						<t t-set='template' t-value="request.env['sale.order.template'].search([('id', '=', doc.sale_order_template_id.id)])"/>
						
						<t t-set='val' t-value="env['sale.order'].fetch_ac_values(doc.id)"/>
						<t t-set='content' t-value='val[1:]'/>
						<t t-set='dp_dat' t-value='val[0]'/>
						
						<div class='row'>
							<div class="col-4"></div>
							<div class="col-6"><h5>Accomplishment Report - Billing <t t-esc="dp_dat['Base']['billing_num']"/></h5></div>
						</div>
						<div class='row'><h6>PROJECT: <t t-esc="template.name"/></h6></div>
						<div class='row'><h6>COMPANY: <t t-esc="cust.name"/></h6></div>
						<div class='row'><h6>DATE: <t t-esc="dp_dat['Base']['date'].strftime('%A - %B %d, %Y')"/></h6></div>
						
						<t t-set="base_amt_total" t-value="0"/>
						<t t-set="prev_amt_total" t-value="0"/>
						<t t-set="this_amt_total" t-value="0"/>
						<t t-set="todate_amt_total" t-value="0"/>

						<div class="row">
							<table class="table table-bordered">
								<thead>                   
									<tr>
										<th rowspan="3" scope="col" class="text-center align-middle font-weight-bold">#</th>
										<th rowspan="3" scope="col" class="text-center align-middle font-weight-bold">Description</th>
										<th rowspan="3" scope="col" class="text-center align-middle font-weight-bold">Unit</th>
										<th rowspan="3" scope="col" class="text-center align-middle font-weight-bold">Qty</th>
										<th rowspan="3" scope="col" class="text-center align-middle font-weight-bold">Unit Price</th>
										<th rowspan="3" scope="col" class="text-center align-middle font-weight-bold">Total Amount</th>
										<th rowspan="3" scope="col" class="text-center align-middle font-weight-bold">Rel. Wt.%</th>
										<th colspan="6" scope="col" class="text-center align-middle font-weight-bold">Accomplishment</th>
									</tr>
									<tr>
										<th colspan="2" scope="col" class="text-center font-weight-bold">Previous</th>
										<th colspan="2" scope="col" class="text-center font-weight-bold">This Period</th>
										<th colspan="2" scope="col" class="text-center font-weight-bold">To Date</th>
									</tr>
									<tr>
										<th scope="col">%</th>
										<th scope="col">Amount</th>
										<th scope="col">%</th>
										<th scope="col">Amount</th>
										<th scope="col">%</th>
										<th scope="col">Amount</th>
									</tr>
								</thead>
								<tbody>
									<t t-set="ctr" t-value="0"/>
									<t t-set="base_amt" t-value="0"/>
									<t t-set="prev_amt" t-value="0"/>
									<t t-set="this_amt" t-value="0"/>
									<t t-set="todate_amt" t-value="0"/>
									<t t-set="relwt_amt" t-value="0"/>

									<t t-set="base_amt_total" t-value="0"/>
									<t t-set="prev_amt_total" t-value="0"/>
									<t t-set="this_amt_total" t-value="0"/>
									<t t-set="todate_amt_total" t-value="0"/>
									<t t-set="relwt_amt_total" t-value="0"/>
									
									<!-- LOOP -->
									<t t-foreach='content' t-as='ac_dat'>
										<t t-set="base_amt" t-value="base_amt + ac_dat['Base']['Amt']"/>
										<t t-set="prev_amt" t-value="prev_amt + ac_dat['Previous']['Amt']"/>
										<t t-set="this_amt" t-value="this_amt + ac_dat['Current']['Amt']"/>
										<t t-set="todate_amt" t-value="todate_amt + ac_dat['To-date']['Amt']"/>
										<t t-set="relwt_amt" t-value="relwt_amt + ac_dat['Base']['RelWt']"/>

										<t t-set="base_amt_total" t-value="base_amt_total + ac_dat['Base']['Amt']"/>
										<t t-set="prev_amt_total" t-value="prev_amt_total + ac_dat['Previous']['Amt']"/>
										<t t-set="this_amt_total" t-value="this_amt_total + ac_dat['Current']['Amt']"/>
										<t t-set="todate_amt_total" t-value="todate_amt_total + ac_dat['To-date']['Amt']"/>
										<t t-set="relwt_amt_total" t-value="relwt_amt_total + ac_dat['Base']['RelWt']"/>

										<t t-if='(ac_dat["Base"]["type"] == "section" and ctr != 0)'>
											<tr>
												<td colspan="4" class="text-right">Subtotal</td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(base_amt,2))"/></td>
												<td class="text-right"><t t-esc="'{:,}'.format(round(relwt_amt,5))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(prev_amt,2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(this_amt,2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(todate_amt,2))"/></td>
											</tr>
											
											<t t-set="base_amt" t-value="0"/>
											<t t-set="prev_amt" t-value="0"/>
											<t t-set="this_amt" t-value="0"/>
											<t t-set="todate_amt" t-value="0"/>
											<t t-set="relwt_amt" t-value="0"/>
										</t>

										<t t-if='ac_dat["Base"]["type"] == "section"'>
											<tr class="bg-info">
												<td><t t-esc='ac_dat["Base"]["seq"]'/></td>
												<td colspan="15"><t t-esc='ac_dat["Base"]["Desc"]'/></td>
											</tr>
										</t>

										<t t-if='ac_dat["Base"]["type"] != "section"'>
											<tr>
												<td><t t-esc='ac_dat["Base"]["seq"]'/></td>
												<td><t t-esc='ac_dat["Base"]["Desc"]'/></td>
												<td><t t-esc='ac_dat["Base"]["unit"]'/></td>
												<td><t t-esc='ac_dat["Base"]["qty"]'/></td>
												<td><t t-esc='"{:,}".format(round(ac_dat["Base"]["priceUnit"],2))'/></td>
												<td><t t-esc='"{:,}".format(round(ac_dat["Base"]["Amt"],2))'/></td>
												<td><t t-esc='ac_dat["Base"]["RelWt"]'/></td>
												
												<td><t t-esc='round(ac_dat["Previous"]["%"],2)'/></td>
												<td><t t-esc='"{:,}".format(round(ac_dat["Previous"]["Amt"],2))'/></td>

												<td><t t-esc='round(ac_dat["Current"]["%"],2)'/></td>
												<td><t t-esc='"{:,}".format(round(ac_dat["Current"]["Amt"],2))'/></td>

												<td><t t-esc='round(ac_dat["To-date"]["%"],2)'/></td>
												<td><t t-esc='"{:,}".format(round(ac_dat["To-date"]["Amt"],2))'/></td>
											</tr>
										</t>

										<t t-if='int(len(content)) == int(ctr+1)'>
											<tr>
												<td colspan="4" class="text-right">Subtotal</td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(base_amt,2))"/></td>
												<td class="text-right"><t t-esc="'{:,}'.format(round(relwt_amt,5))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(prev_amt,2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(this_amt,2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(todate_amt,2))"/></td>
											</tr>

											<tr>
												<strong>
												<td colspan="4" class="text-right">Downpayment</td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(dp_dat['Base']['Amt'],2))"/></td>
												<td class="text-right"></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(dp_dat['Previous']['Amt'],2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(dp_dat['Current']['Amt'],2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(dp_dat['To-date']['Amt'],2))"/></td>
												</strong>
											</tr>

											<tr>
												<strong>
												<td colspan="4" class="text-right">Total</td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(base_amt_total+dp_dat['Base']['Amt'],2))"/></td>
												<td class="text-right"><t t-esc="'{:,}'.format(round(relwt_amt_total,0))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(prev_amt_total+dp_dat['Previous']['Amt'],2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(this_amt_total+dp_dat['Current']['Amt'],2))"/></td>
												<td colspan="2" class="text-right"><t t-esc="'{:,}'.format(round(todate_amt_total+dp_dat['To-date']['Amt'],2))"/></td>
												</strong>
											</tr>
											
											<t t-set="base_amt" t-value="0"/>
											<t t-set="prev_amt" t-value="0"/>
											<t t-set="this_amt" t-value="0"/>
											<t t-set="todate_amt" t-value="0"/>
											<t t-set="relwt_amt" t-value="0"/>
										</t>

										<t t-set="ctr" t-value="ctr+1"/>
									</t>
									<!-- END LOOP -->
								</tbody>
							</table>
						</div>

						<t t-set="DP" t-value="0"/>
						<t t-set="REC" t-value="0"/>

						<t t-if="dp_dat['Base']['Amt'] == dp_dat['Current']['Amt']">
							<t t-set="DP" t-value="'{:,}'.format(round(dp_dat['Base']['Amt'],2))"/>
						</t>
						<t t-if="dp_dat['Base']['Amt'] > dp_dat['Current']['Amt']">
							<t t-set="REC" t-value="'{:,}'.format(round(dp_dat['Current']['Amt'],2))"/>
						</t>

						<!-- <t t-esc="dp_dat"/> -->
						<div style="page-break-inside: avoid;">
							<div class="row">
								<div class="col-8"></div>
								<div class="col-4"><h5>Downpayment: <t t-esc="DP"/></h5></div>
							</div>
							<div class="row">
								<div class="col-8"></div>
								<div class="col-4"><h5>Recoupment: <t t-esc="REC"/></h5></div>
							</div>
							<div class="row">
								<div class="col-8"></div>
								<div class="col-4" style="border-bottom:1px solid black;"><h5>Subtotal: <t t-esc="'{:,}'.format(round(this_amt_total,2))"/></h5></div>
							</div>
							<div class="row">
								<div class="col-8"></div>
								<div class="col-4" style="border-bottom:1px solid black;"><h5>Net Total: <t t-esc="'{:,}'.format(round(this_amt_total+dp_dat['Current']['Amt'],2))"/></h5></div>
							</div>
							<div class="row">
								<div class="col-8"></div>
								<div class="col-4"><h5>Total Billing: <t t-esc="'{:,}'.format(round(todate_amt_total+dp_dat['To-date']['Amt'],2))"/></h5></div>
							</div>
						</div>
						<!-- <span>Total Billed: <t t-esc="'{:,}'.format(round(todate_amt_total+dp_dat['Current']['Amt'],2))"/></span> -->

						<div style="page-break-inside: avoid;">
							<div class="row" style="margin-top:50px">
								<div class="col-4">Prepared By:</div>
								<div class="col-4">Approved By:</div>
								<div class="col-4">Conforme:</div>
							</div>
							<div class="row" style="margin-top:50px">
								<div class="col-3" style="border-bottom:1px solid black;"></div>
								<div class="col-1"></div>
								<div class="col-3" style="border-bottom:1px solid black;"></div>
								<div class="col-1"></div>
								<div class="col-3" style="border-bottom:1px solid black;"></div>
							</div>
							<div class="row">
								<div class="col-4">Signature over Printed Name</div>
								<div class="col-4">Signature over Printed Name</div>
								<div class="col-4">Signature over Printed Name</div>
							</div>
						</div>
					</div>
				<!-- </t> -->
			</t>
		</t>
	</template>
</odoo>
